!function(){"use strict";var Locator=window.Locator={};Locator.defaultSearchSettings={selectors:{map:".loc-srch-res-map",list:".loc-srch-res-list",teaser:".loc-teaser",form:".loc-srch-form",loader:".loc-loader",trigger:".loc-trigger",results:".loc-srch-res"},stickyMap:0,baseUrl:"/"},Locator.Form=Class.create({initialize:function(el,search){this.settings={selectors:{loader:".loc-loader"}},this.el=el,this.search=search;var self=this;Event.observe(el,"submit",function(event){var params=el.serialize().toQueryParams();for(var key in params)params.hasOwnProperty(key)&&"undefined"!=params[key]&&""==params[key]&&delete params[key];self.startLoader(),self.search.findLocations(params,function(){self.stopLoader()}),Event.stop(event)})},startLoader:function(){this.el.select(this.settings.selectors.loader).each(function(el){el.addClassName("is-loading")})},stopLoader:function(){this.el.select(this.settings.selectors.loader).each(function(el){el.removeClassName("is-loading")})}}),Locator.Map=Class.create({initialize:function(el){var theme=this.getTheme();if(this.el=el,this.defaults={zoom:15,scrollwheel:!1,mapTypeId:google.maps.MapTypeId.ROADMAP,mapTypeControl:!1,mapTypeControlOptions:{style:google.maps.MapTypeControlStyle.HORIZONTAL_BAR,position:google.maps.ControlPosition.BOTTOM_CENTER,mapTypeIds:[google.maps.MapTypeId.ROADMAP,"locator"]},streetViewControl:!1,streetViewControlOptions:{position:google.maps.ControlPosition.LEFT_TOP}},this.map=new google.maps.Map(el,this.defaults),this.markers=[],this.infowindows=[],this.stoppers=[],this.settings={maxZoom:15,baseUrl:Locator.defaultSearchSettings.baseUrl},theme){var styledMap=new google.maps.StyledMapType(theme,{name:"Locator"});this.map.mapTypes.set("locator",styledMap),this.map.setMapTypeId("locator")}},renderLocations:function(locations,coords){var latlngbounds=new google.maps.LatLngBounds,show=0,self=this;if(this.clearOverlays(),coords){var lat=coords[1],long=coords[0],loc=new google.maps.LatLng(lat,long);self.markers.point=new google.maps.Marker({position:loc,map:self.map}),latlngbounds.extend(loc)}for(var key in locations)if(locations.hasOwnProperty(key)){var l=locations[key],loc=new google.maps.LatLng(l.latitude,l.longitude);self.infowindows[l.id]=new google.maps.InfoWindow({content:'<div id="content"><span class="loader loc-infowindow-loader is-loading">loading</span></div>'}),self.markers[l.id]=new google.maps.Marker({position:loc,map:self.map,title:l.title,icon:self.getMarkerImage(l),animation:google.maps.Animation.DROP}),self.markers[l.id].id=l.id,google.maps.event.addListener(self.markers[l.id],"click",function(){self.showInfoWindow(this.id)}),latlngbounds.extend(loc),show=1}self.map.fitBounds(latlngbounds),self.checkMaxZoom(),google.maps.event.trigger(self.map,"resize"),self.loadInfoWindows()},checkMaxZoom:function(){var self=this;if(self.settings.maxZoom)var listener=google.maps.event.addListener(self.map,"idle",function(){self.map.getZoom()>self.settings.maxZoom&&self.map.setZoom(self.settings.maxZoom),google.maps.event.removeListener(listener)})},clearOverlays:function(){for(var key in this.markers)this.markers.hasOwnProperty(key)&&this.markers[key].setMap(null)},hideInfoWindows:function(){for(var key in this.infowindows)this.infowindows.hasOwnProperty(key)&&this.infowindows[key].close()},showInfoWindow:function(id){var self=this;self.hideInfoWindows(),self.infowindows[id].open(self.map,self.markers[id]),self.infowindows[id].isSet||new Ajax.Request(this.settings.baseUrl+"locator/search/infowindow/id/"+id,{method:"get",onFailure:function(){alert("failed")},onSuccess:function(t){self.setInfoWindowContent(id,t.responseText)}})},setInfoWindowContent:function(id,content){this.infowindows[id].setContent(content),this.infowindows[id].isSet=1},loadInfoWindows:function(){var self=this,ids=[];for(var key in self.infowindows)self.infowindows.hasOwnProperty(key)&&!self.infowindows[key].isSet&&self.markers[key]&&ids.push(key);new Ajax.Request(this.settings.baseUrl+"locator/search/infowindows/?ids="+ids.join(),{method:"get",onFailure:function(){alert("failed")},onSuccess:function(t){var windows=JSON.parse(t.responseText);for(var key in windows)windows.hasOwnProperty(key)&&"undefined"!=windows[key]&&self.setInfoWindowContent(key,windows[key])}})},highlightMarker:function(id){var self=this;null===self.markers[id].getAnimation()&&(self.markers[id].setAnimation(google.maps.Animation.BOUNCE),self.stoppers[id]=setTimeout(function(){self.markers[id].setAnimation(null)},720))},getMarkerImage:function(){return new google.maps.MarkerImage("/skin/frontend/base/default/locator/images/pin.png",new google.maps.Size(40,50),new google.maps.Point(0,0),new google.maps.Point(20,50))},getTheme:function(){return!1}}),Locator.List=Class.create({initialize:function(el){this.el=el},update:function(text){this.el.update(text)}}),Locator.Search=Class.create({initialize:function(options){options&&(options.settings&&(this.settings=$H(Locator.defaultSearchSettings).merge(options.settings)),options.map&&(this.map=options.map)),this.settings||(this.settings=Locator.defaultSearchSettings),!this.map&&$$(this.settings.selectors.map).first()&&(this.map=new Locator.Map($$(this.settings.selectors.map).first())),$$(this.settings.selectors.list).first()&&(this.list=new Locator.List($$(this.settings.selectors.list).first())),this.forms=[];var self=this;this.initScroll(),$$(this.settings.selectors.form).each(function(el){self.forms.push(new Locator.Form(el,self))}),window.History.Adapter.bind(window,"statechange",function(){var State=History.getState();State.data.locations&&State.data.locations.length&&(self.list&&self.list.update(State.data.output),self.map&&(State.data.search_point?self.map.renderLocations(State.data.locations,State.data.search_point.coords):self.map.renderLocations(State.data.locations))),self.initEvents()})},initState:function(data){var href=window.location.href+"&rand="+Math.random(),state={};return state.output=this.list.el.innerHTML,state.href=href.toQueryParams(),""!==data.locations&&(state.locations=this.parseLocationsJson(data.locations)),data.search_point&&(state.search_point=data.search_point),state.locations.length||this.toggleNoResults(!0),History.getHash()&&(window.location.hash=""),History.replaceState(state,this.getSearchTitle(state.locations),window.location.search),this},findLocations:function(query,callback){var href,self=this;return"object"==typeof query&&(query=$H(query).toQueryString()),href=this.settings.baseUrl+"locator/search/?"+query,new Ajax.Request(href+"&xhr=1",{method:"get",onFailure:function(){alert("search failed")},onSuccess:function(t){var result=self.parseSearchJson(t.responseText);result.search=href.toQueryParams(),self.toggleNoResults(!1),result.error===!0?"noresults"===result.error_type?self.toggleNoResults(!0):alert(result.message):result.locations.length?History.pushState(result,self.getSearchTitle(result.locations),"?"+query):alert("an error occured"),"function"==typeof callback&&callback.call()}}),this},parseSearchJson:function(string){var search=JSON.parse(string);return search.locations&&(search.locations=this.parseLocationsJson(search.locations)),search},parseLocationsJson:function(string){var locations=JSON.parse(string),temp=[];for(var key in locations)locations.hasOwnProperty(key)&&"undefined"!=locations[key]&&temp.push(locations[key]);return temp},toggleNoResults:function(empty){var els=$$(this.settings.selectors.results);return els.each(empty?function(el){el.addClassName("is-no-results")}:function(el){el.removeClassName("is-no-results")}),this},initEvents:function(){var self=this;return $$(self.settings.selectors.teaser).invoke("observe","click",function(){var id=this.readAttribute("data-id");self.map.showInfoWindow(id)}),$$(self.settings.selectors.teaser).invoke("observe","mouseover",function(){var id=this.readAttribute("data-id");self.map.highlightMarker(id)}),$$(self.settings.selectors.trigger).invoke("observe","click",function(event){var el=Event.element(event);if(!el.readAttribute("href"))for(var i=0;10>i&&(el=el.up(),!el.readAttribute("href"));i++);var href=el.readAttribute("href");self.forms[0].startLoader(),self.findLocations(href.toQueryParams(),function(){self.forms[0].stopLoader()}),Event.stop(event)}),setTimeout(function(){google.maps.event.addListener(self.map.map,"zoom_changed",function(){self.hideNonVisible()}),google.maps.event.addListener(self.map.map,"dragend",function(){self.hideNonVisible()})},1e3),this},hideNonVisible:function(){var map=this.map;for(var key in map.markers)if(map.markers.hasOwnProperty(key)){var marker=map.markers[key],teaser=$$(this.settings.selectors.list+" "+this.settings.selectors.teaser+"[data-id="+key+"]").first();map.map.getBounds().contains(marker.getPosition())?(teaser&&teaser.removeClassName("is-hidden"),marker.setVisible(!0)):(teaser&&!teaser.hasClassName("loc-closest")&&teaser.addClassName("is-hidden"),marker.setVisible(!1))}return this},getSearchTitle:function(locations){return"Search: "+locations.length+" Locations"},initScroll:function(){if(this.settings.stickyMap){var map=$$(".loc-srch-res-map-wrap").first(),results=$$(this.settings.selectors.results).first();Event.observe(document,"scroll",function(){results.viewportOffset().top<1?map.addClassName("is-fixed"):map.removeClassName("is-fixed")})}return this}})}();
//# sourceMappingURL=locator.js.map